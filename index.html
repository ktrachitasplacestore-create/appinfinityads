<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads Infinit: Tus Anuncios UGC</title>
    
    <!-- Tailwind CSS para un diseño rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts para una tipografía elegante -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados para complementar Tailwind */
        body {
            font-family: 'Lexend', sans-serif;
            background: #111827; /* Fondo oscuro principal */
            background: linear-gradient(135deg, #111827 0%, #1a1a3d 50%, #4c1d95 100%);
            min-height: 100vh;
        }

        /* Efecto de "glassmorphism" para los paneles */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Estilo para los inputs de archivo */
        input[type="file"]::file-selector-button {
            background-color: #c026d3; /* Fucsia */
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: #a21caf; /* Fucsia más oscuro */
        }

        /* Animación para el spinner de carga */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center p-4">

    <!-- Contenedor Principal -->
    <div class="w-full max-w-4xl mx-auto">

        <!-- ==================================== -->
        <!--      PANTALLA DE LOGIN/REGISTRO      -->
        <!-- ==================================== -->
        <div id="login-screen">
            <div class="glass-panel rounded-2xl shadow-2xl p-8 md:p-12 text-center">
                <svg class="mx-auto h-12 w-auto text-violet-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 1-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 1 3.09-3.09L12 5.25l.813 2.846a4.5 4.5 0 0 1 3.09 3.09L18.75 12l-2.846.813a4.5 4.5 0 0 1-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" />
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold mt-4">Ads Infinit</h1>
                <p class="text-violet-300 mt-2 mb-8">Tus anuncios UGC como quieras</p>

                <form id="login-form" class="space-y-6">
                    <div>
                        <input type="email" id="email" name="email" placeholder="Tu correo electrónico" required class="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition">
                    </div>
                    <div>
                        <input type="password" id="password" name="password" placeholder="Tu contraseña" required class="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition">
                    </div>
                    <button type="submit" id="login-button" class="w-full bg-fuchsia-600 hover:bg-fuchsia-700 disabled:bg-fuchsia-900 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg shadow-fuchsia-600/30">
                        Iniciar Sesión
                    </button>
                </form>
                <p class="text-gray-400 text-sm mt-6">
                    ¿Aún no tienes una cuenta? 
                    <a href="#" id="register-link" class="font-medium text-fuchsia-400 hover:text-fuchsia-300">Regístrate Aquí</a>
                </p>
                <p id="login-error" class="text-red-400 mt-4 h-5"></p>
            </div>
        </div>

        <!-- ==================================== -->
        <!--    PANTALLA DE GENERADOR DE IMAGEN   -->
        <!-- ==================================== -->
        <div id="generator-screen" class="hidden">
            <div class="glass-panel rounded-2xl shadow-2xl p-6 md:p-8">
                <!-- Cabecera con créditos y logout -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Crear Anuncio UGC</h2>
                    <div class="flex items-center gap-4">
                        <div class="bg-gray-900/50 border border-gray-600 rounded-full px-4 py-2 text-sm font-medium">
                            Créditos: <span id="credit-balance" class="font-bold text-violet-300">0</span>
                        </div>
                        <button id="logout-button" title="Cerrar Sesión" class="text-gray-400 hover:text-white transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>
                </div>

                <form id="generator-form">
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Columna de Inputs -->
                        <div class="space-y-6">
                            <!-- Input Foto del Producto -->
                            <div>
                                <label for="product-image" class="block mb-2 font-medium">1. Foto del Producto</label>
                                <input type="file" id="product-image" required accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-fuchsia-600 file:text-white hover:file:bg-fuchsia-700 transition">
                                <div class="mt-4 aspect-square bg-gray-900/50 rounded-lg flex items-center justify-center overflow-hidden">
                                    <img id="product-preview" src="" alt="Vista previa del producto" class="hidden w-full h-full object-cover">
                                    <span class="text-gray-500 product-placeholder">Vista previa</span>
                                </div>
                            </div>
                             <!-- Input Foto del Personaje -->
                            <div>
                                <label for="character-image" class="block mb-2 font-medium">2. Foto del Personaje/Modelo</label>
                                <input type="file" id="character-image" required accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-fuchsia-600 file:text-white hover:file:bg-fuchsia-700 transition">
                                 <div class="mt-4 aspect-square bg-gray-900/50 rounded-lg flex items-center justify-center overflow-hidden">
                                    <img id="character-preview" src="" alt="Vista previa del personaje" class="hidden w-full h-full object-cover">
                                    <span class="text-gray-500 character-placeholder">Vista previa</span>
                                </div>
                            </div>
                             <!-- Selector de Escenario -->
                            <div>
                                <label for="scenario" class="block mb-2 font-medium">3. Elige un escenario y estilo</label>
                                <select id="scenario" required class="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition">
                                    <option value="modern_office">Oficina Moderna</option>
                                    <option value="natural_setting">Entorno Natural</option>
                                    <option value="lifestyle_setting">Estilo de vida cotidiano</option>
                                    <option value="urban_environment">Entorno Urbano</option>
                                    <option value="tropical_beach">Playa Tropical</option>
                                    <option value="studio_backdrop">Fondo de Estudio</option>
                                    <option value="professional_photoshoot">Sesión fotográfica profesional</option>
                                    <option value="dynamic_scene">Escena dinámica</option>
                                    <option value="elegant_atmosphere">Ambiente elegante</option>
                                    <option value="modern_context">Contexto moderno</option>
                                    <option value="urban_street">Calle Urbana</option>
                                </select>
                            </div>
                        </div>

                        <!-- Columna de Output -->
                        <div class="flex flex-col">
                            <p class="font-medium mb-2">4. Resultado</p>
                            <div id="output-area" class="flex-grow w-full aspect-square bg-gray-900/50 rounded-lg flex flex-col items-center justify-center p-4 text-center text-gray-500">
                                <!-- Estado inicial -->
                                <div id="initial-state">
                                    <svg class="mx-auto h-16 w-16 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                                    </svg>
                                    <p class="mt-2">La imagen generada aparecerá aquí.</p>
                                </div>
                                <!-- Estado de carga -->
                                <div id="loading-state" class="hidden">
                                     <div class="spinner w-12 h-12 rounded-full border-4 border-t-fuchsia-500 border-gray-600"></div>
                                     <p class="mt-4">Generando imagen, esto puede tardar un momento...</p>
                                </div>
                                <!-- Imagen generada -->
                                <img id="generated-image" src="" class="hidden w-full h-full object-contain rounded-lg">
                            </div>
                            <div class="mt-4 space-y-4">
                               <p id="generator-error" class="text-red-400 text-center h-5"></p>
                               <button type="submit" id="generate-button" class="w-full bg-fuchsia-600 hover:bg-fuchsia-700 disabled:bg-fuchsia-900 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-lg shadow-fuchsia-600/30">
                                   Generar Imagen
                               </button>
                               <a id="download-button" href="#" download="anuncio-ugc.png" class="hidden w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">
                                   Descargar Imagen
                               </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
    // =======================================================
    //          CONFIGURACIÓN DE LOS WEBHOOKS DE N8N
    // =======================================================
    const N8N_LOGIN_WEBHOOK = 'https://miia360n8n.ktrachitas.store/webhook/auth';
    const N8N_GENERATE_WEBHOOK = 'https://miia360n8n.ktrachitas.store/webhook/generate-image';


    // =======================================================
    //          SELECCIÓN DE ELEMENTOS DEL DOM
    // =======================================================
    const loginScreen = document.getElementById('login-screen');
    const generatorScreen = document.getElementById('generator-screen');
    
    // Formulario de Login
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const loginError = document.getElementById('login-error');
    const registerLink = document.getElementById('register-link');

    // Pantalla del Generador
    const logoutButton = document.getElementById('logout-button');
    const creditBalanceSpan = document.getElementById('credit-balance');
    const generatorForm = document.getElementById('generator-form');
    const generateButton = document.getElementById('generate-button');
    const generatorError = document.getElementById('generator-error');

    // Inputs de imagen y select
    const productImageInput = document.getElementById('product-image');
    const characterImageInput = document.getElementById('character-image');
    const scenarioSelect = document.getElementById('scenario');

    // Vistas previas de imagen
    const productPreview = document.getElementById('product-preview');
    const characterPreview = document.getElementById('character-preview');
    const productPlaceholder = document.querySelector('.product-placeholder');
    const characterPlaceholder = document.querySelector('.character-placeholder');

    // Área de resultado
    const outputArea = document.getElementById('output-area');
    const initialState = document.getElementById('initial-state');
    const loadingState = document.getElementById('loading-state');
    const generatedImage = document.getElementById('generated-image');
    const downloadButton = document.getElementById('download-button');


    // =======================================================
    //          ESTADO GLOBAL DE LA APLICACIÓN
    // =======================================================
    let userAuthToken = null; // Variable para almacenar el token de autenticación del usuario


    // =======================================================
    //                 LÓGICA DE LA APLICACIÓN
    // =======================================================

    /**
     * Muestra una vista previa de la imagen seleccionada en un input de archivo.
     * @param {HTMLInputElement} input - El input de archivo.
     * @param {HTMLImageElement} previewElement - El elemento img para la vista previa.
     * @param {HTMLElement} placeholderElement - El elemento placeholder a ocultar.
     */
    function showImagePreview(input, previewElement, placeholderElement) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewElement.src = e.target.result;
                previewElement.classList.remove('hidden');
                placeholderElement.classList.add('hidden');
            }
            reader.readAsDataURL(file);
        }
    }

    // Event listeners para las vistas previas
    productImageInput.addEventListener('change', () => showImagePreview(productImageInput, productPreview, productPlaceholder));
    characterImageInput.addEventListener('change', () => showImagePreview(characterImageInput, characterPreview, characterPlaceholder));

    
    /**
     * Maneja el envío del formulario de login o registro.
     * @param {'login' | 'register'} action - La acción a realizar.
     */
    async function performAuthAction(action) {
        if (!loginForm.checkValidity()) {
            loginForm.reportValidity();
            return;
        }

        loginButton.disabled = true;
        loginButton.textContent = 'Verificando...';
        loginError.textContent = '';

        try {
            const response = await fetch(N8N_LOGIN_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: emailInput.value,
                    password: passwordInput.value,
                    action: action
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                const errorMessage = Array.isArray(errorData) ? errorData[0]?.message : errorData?.message;
                throw new Error(errorMessage || 'Credenciales incorrectas o error en el servidor.');
            }

            const responseData = await response.json();
            const data = Array.isArray(responseData) ? responseData[0] : responseData;

            if (!data) {
                throw new Error('Respuesta inesperada del servidor.');
            }

            if (data.success && data.token && data.user) {
                userAuthToken = data.token; 
                updateCreditBalance(data.user.credits);
                loginScreen.classList.add('hidden');
                generatorScreen.classList.remove('hidden');
            } else {
                throw new Error(data.message || 'No se pudo iniciar sesión.');
            }

        } catch (error) {
            loginError.textContent = error.message;
        } finally {
            loginButton.disabled = false;
            loginButton.textContent = 'Iniciar Sesión';
        }
    }

    /**
     * Maneja el envío del formulario de generación de imagen.
     * @param {Event} e - El evento de envío del formulario.
     */
    async function handleGeneration(e) {
        e.preventDefault();
        
        if (!productImageInput.files[0] || !characterImageInput.files[0]) {
            generatorError.textContent = 'Por favor, sube ambas imágenes.';
            return;
        }

        setGeneratorState('loading');

        const formData = new FormData();
        formData.append('productImage', productImageInput.files[0]);
        formData.append('characterImage', characterImageInput.files[0]);
        formData.append('scenario', scenarioSelect.value);
        
        if (userAuthToken) {
            formData.append('token', userAuthToken);
        } else {
            setGeneratorState('error', 'Error de autenticación. Por favor, vuelve a iniciar sesión.');
            setTimeout(handleLogout, 2000);
            return;
        }

        try {
            const response = await fetch(N8N_GENERATE_WEBHOOK, {
                method: 'POST',
                body: formData
            });
            
            // --- INICIO DE LA LÓGICA NUEVA ---
            // Leemos la respuesta como JSON, ya que el backend ahora devuelve una URL y los créditos en este formato.
            const responseData = await response.json();

            // Si la respuesta HTTP no es exitosa (ej. 4xx, 5xx), lanzamos un error con el mensaje del JSON.
            if (!response.ok) {
                 const errorInfo = Array.isArray(responseData) ? responseData[0] : responseData;
                 throw new Error(errorInfo.message || 'Error al generar la imagen. ¿Créditos insuficientes?');
            }
            
            // Si la respuesta es exitosa, procesamos el JSON.
            const resultData = Array.isArray(responseData) ? responseData[0] : responseData;
            
            // Verificamos que el JSON tiene los campos que esperamos: 'image_url' y 'fields.credits_remaining'
            if (resultData.image_url && resultData.fields && typeof resultData.fields.credits_remaining !== 'undefined') {
                const imageUrl = resultData.image_url;
                const newCredits = resultData.fields.credits_remaining;

                updateCreditBalance(newCredits);
                setGeneratorState('result', imageUrl);
            } else {
                throw new Error('La respuesta del servidor tiene un formato inesperado.');
            }
            // --- FIN DE LA LÓGICA NUEVA ---

        } catch (error) {
            // Si el error es de sintaxis (ej. 'Unexpected token <'), significa que la respuesta no fue JSON.
            if (error instanceof SyntaxError) {
                 setGeneratorState('error', 'Error inesperado del servidor. La respuesta no era un JSON válido.');
            } else {
                setGeneratorState('error', error.message);
            }
        }
    }

    /**
     * Actualiza el contador de créditos en la UI.
     * @param {number} credits - El nuevo saldo de créditos.
     */
    function updateCreditBalance(credits) {
        creditBalanceSpan.textContent = credits;
    }

    /**
     * Cambia el estado del área de generación de imagen.
     * @param {'initial'|'loading'|'result'|'error'} state - El estado a mostrar.
     * @param {string} [data] - Dato adicional (URL de imagen o mensaje de error).
     */
    function setGeneratorState(state, data) {
        // Ocultar todo primero
        initialState.classList.add('hidden');
        loadingState.classList.add('hidden');
        generatedImage.classList.add('hidden');
        downloadButton.classList.add('hidden');
        generateButton.disabled = false;
        generatorError.textContent = '';

        switch (state) {
            case 'loading':
                loadingState.classList.remove('hidden');
                generateButton.disabled = true;
                break;
            case 'result':
                generatedImage.src = data;
                generatedImage.classList.remove('hidden');
                downloadButton.href = data;
                downloadButton.classList.remove('hidden');
                break;
            case 'error':
                 initialState.classList.remove('hidden');
                 generatorError.textContent = data;
                 break;
            case 'initial':
            default:
                initialState.classList.remove('hidden');
                generatedImage.src = '';
                productPreview.src = '';
                characterPreview.src = '';
                productPreview.classList.add('hidden');
                characterPreview.classList.add('hidden');
                productPlaceholder.classList.remove('hidden');
                characterPlaceholder.classList.remove('hidden');
                generatorForm.reset();
                break;
        }
    }

    /**
     * Maneja el cierre de sesión del usuario.
     */
    function handleLogout() {
        // Limpiar datos y volver a la pantalla de login
        userAuthToken = null; // MUY IMPORTANTE: Limpiar el token al cerrar sesión
        emailInput.value = '';
        passwordInput.value = '';
        generatorScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        setGeneratorState('initial');
        updateCreditBalance(0);
    }
    
    // Asignación de event listeners
    generatorForm.addEventListener('submit', handleGeneration);
    logoutButton.addEventListener('click', handleLogout);

    loginButton.addEventListener('click', (e) => {
        e.preventDefault();
        performAuthAction('login');
    });

    registerLink.addEventListener('click', (e) => {
        e.preventDefault();
        performAuthAction('register');
    });

    </script>
</body>
</html>
